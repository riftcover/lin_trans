# ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥å¤„ç†ä¿®å¤è®¡åˆ’

## ğŸ” **é—®é¢˜åˆ†æ**

### å½“å‰é—®é¢˜
- **ç½‘ç»œè¿æ¥å¤±è´¥**ï¼š`[WinError 10061] ç”±äºç›®æ ‡è®¡ç®—æœºç§¯ææ‹’ç»ï¼Œæ— æ³•è¿æ¥`
- **æ‰£è´¹å¤±è´¥ä½†ä»»åŠ¡ç»§ç»­**ï¼šç¿»è¯‘ä»»åŠ¡å®Œæˆï¼Œä½†å®é™…æ²¡æœ‰æ‰£è´¹
- **æ—¥å¿—è¯¯å¯¼**ï¼šæ˜¾ç¤º"æ‰£è´¹å®Œæˆ"ä½†å®é™…æ‰£è´¹å¤±è´¥

### æ ¹æœ¬åŸå› 
1. `TransTaskManager.consume_tokens_for_task`æ²¡æœ‰è¿”å›æ‰£è´¹ç»“æœ
2. ä»»åŠ¡å¤„ç†å™¨æ²¡æœ‰æ£€æŸ¥æ‰£è´¹ç»“æœ
3. æ‰£è´¹å¤±è´¥æ—¶ä»»åŠ¡ä»ç„¶æ ‡è®°ä¸ºæˆåŠŸ

## ğŸ“‹ **ä¿®å¤è®¡åˆ’**

### âœ… é˜¶æ®µ1ï¼šä¿®å¤æ‰£è´¹é€»è¾‘å’Œæ—¥å¿—ï¼ˆå·²å®Œæˆï¼‰

#### 1.1 ä¿®æ”¹TransTaskManager.consume_tokens_for_task
- **è¿”å›å€¼**ï¼šæ”¹ä¸ºè¿”å›`bool`ç±»å‹ï¼Œè¡¨ç¤ºæ‰£è´¹æ˜¯å¦æˆåŠŸ
- **æ—¥å¿—ä¼˜åŒ–**ï¼šä½¿ç”¨âœ…âŒç¬¦å·æ¸…æ™°æ ‡è¯†æ‰£è´¹ç»“æœ
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œè¿”å›false

#### 1.2 ä¿®æ”¹ä»»åŠ¡å¤„ç†å™¨æ‰£è´¹è°ƒç”¨
- **æ£€æŸ¥æ‰£è´¹ç»“æœ**ï¼šæ ¹æ®è¿”å›å€¼åˆ¤æ–­æ‰£è´¹æ˜¯å¦æˆåŠŸ
- **å¤±è´¥å¤„ç†**ï¼šæ‰£è´¹å¤±è´¥æ—¶ä»»åŠ¡å¤±è´¥ï¼Œé€šçŸ¥UIé”™è¯¯
- **æ—¥å¿—å‡†ç¡®æ€§**ï¼šåªæœ‰çœŸæ­£æ‰£è´¹æˆåŠŸæ‰è®°å½•"æ‰£è´¹å®Œæˆ"

### ğŸ”„ é˜¶æ®µ2ï¼šå¢å¼ºé”™è¯¯å¤„ç†ç­–ç•¥ï¼ˆå¾…å®ç°ï¼‰

#### 2.1 ç½‘ç»œé”™è¯¯é‡è¯•æœºåˆ¶
```python
def consume_tokens_with_retry(self, task_id: str, max_retries: int = 3) -> bool:
    """å¸¦é‡è¯•çš„æ‰£è´¹æ–¹æ³•"""
    for attempt in range(max_retries):
        try:
            if self.consume_tokens_for_task(task_id):
                return True
            time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
        except NetworkError:
            if attempt == max_retries - 1:
                return False
            time.sleep(2 ** attempt)
    return False
```

#### 2.2 æ‰£è´¹çŠ¶æ€æŒä¹…åŒ–
```python
class BillingStatus:
    PENDING = "pending"      # å¾…æ‰£è´¹
    SUCCESS = "success"      # æ‰£è´¹æˆåŠŸ
    FAILED = "failed"        # æ‰£è´¹å¤±è´¥
    RETRYING = "retrying"    # é‡è¯•ä¸­
```

#### 2.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º**ï¼šåŒºåˆ†"ç¿»è¯‘å®Œæˆ"å’Œ"æ‰£è´¹å®Œæˆ"
- **é‡è¯•æŒ‰é’®**ï¼šå…è®¸ç”¨æˆ·æ‰‹åŠ¨é‡è¯•æ‰£è´¹
- **æ‰¹é‡è¡¥æ‰£è´¹**ï¼šç½‘ç»œæ¢å¤åæ‰¹é‡å¤„ç†å¤±è´¥çš„æ‰£è´¹

### ğŸš€ é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ï¼ˆæœªæ¥æ‰©å±•ï¼‰

#### 3.1 ç¦»çº¿æ‰£è´¹é˜Ÿåˆ—
- ç½‘ç»œæ–­å¼€æ—¶å°†æ‰£è´¹è¯·æ±‚å­˜å‚¨åˆ°æœ¬åœ°é˜Ÿåˆ—
- ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨å¤„ç†é˜Ÿåˆ—ä¸­çš„æ‰£è´¹è¯·æ±‚

#### 3.2 æ‰£è´¹çŠ¶æ€ç›‘æ§
- å®æ—¶ç›‘æ§æ‰£è´¹æˆåŠŸç‡
- ç½‘ç»œçŠ¶æ€æ£€æµ‹å’Œå‘Šè­¦

#### 3.3 ç”¨æˆ·ä½™é¢ç¼“å­˜
- æœ¬åœ°ç¼“å­˜ç”¨æˆ·ä½™é¢ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- å®šæœŸåŒæ­¥æœåŠ¡ç«¯ä½™é¢

## ğŸ”§ **å·²å®ç°çš„ä¿®å¤**

### ä¿®å¤1ï¼šTransTaskManagerè¿”å›æ‰£è´¹ç»“æœ
```python
def consume_tokens_for_task(self, task_id: str) -> bool:
    """è¿”å›æ‰£è´¹æ˜¯å¦æˆåŠŸ"""
    try:
        billing_success = token_service.consume_tokens(token_amount, "cloud_trans")
        if billing_success:
            logger.info(f"âœ… ç¿»è¯‘ä»»åŠ¡æ‰£è´¹æˆåŠŸ - ç®—åŠ›: {token_amount}, ä»»åŠ¡ID: {task_id}")
            return True
        else:
            logger.error(f"âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥ - ç®—åŠ›: {token_amount}, ä»»åŠ¡ID: {task_id}")
            return False
    except Exception as e:
        logger.error(f"âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¼‚å¸¸ - ä»»åŠ¡ID: {task_id}, é”™è¯¯: {str(e)}")
        return False
```

### ä¿®å¤2ï¼šä»»åŠ¡å¤„ç†å™¨æ£€æŸ¥æ‰£è´¹ç»“æœ
```python
# å°è¯•æ‰£è´¹
billing_success = TransTaskManager().consume_tokens_for_task(task.unid)

if billing_success:
    logger.info(f'âœ… ç¿»è¯‘ä»»åŠ¡å®Œæˆå¹¶æ‰£è´¹æˆåŠŸ - ä»»åŠ¡ID: {task.unid}')
else:
    logger.error(f'âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥ï¼Œä»»åŠ¡çŠ¶æ€å¼‚å¸¸ - ä»»åŠ¡ID: {task.unid}')
    # æ‰£è´¹å¤±è´¥æ—¶ï¼Œé€šçŸ¥UIä»»åŠ¡å‡ºé”™
    data_bridge.emit_task_error(task.unid, "æ‰£è´¹å¤±è´¥")
    raise Exception(f"ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥: {task.unid}")
```

## ğŸ“Š **ä¿®å¤æ•ˆæœ**

### ä¿®å¤å‰çš„æ—¥å¿—
```
2025-09-11 10:05:34.038 | WARNING  | app.cloud_trans.task_manager:consume_tokens_for_task:38 - ç¿»è¯‘ä»£å¸æ¶ˆè´¹å¤±è´¥: 3
2025-09-11 10:05:34.038 | INFO     | nice_ui.task.queue_worker:process:275 - ASR+ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å®Œæˆï¼Œä»»åŠ¡ID: xxx
```
**é—®é¢˜**ï¼šæ‰£è´¹å¤±è´¥ä½†æ˜¾ç¤º"æ‰£è´¹å®Œæˆ"

### ä¿®å¤åçš„æ—¥å¿—
```
2025-09-11 10:05:34.038 | ERROR    | app.cloud_trans.task_manager:consume_tokens_for_task:45 - âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥ - ç®—åŠ›: 3, ä»»åŠ¡ID: xxx
2025-09-11 10:05:34.038 | ERROR    | nice_ui.task.queue_worker:process:275 - âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥ï¼Œä»»åŠ¡çŠ¶æ€å¼‚å¸¸ - ä»»åŠ¡ID: xxx
```
**æ”¹è¿›**ï¼šæ¸…æ™°æ ‡è¯†æ‰£è´¹å¤±è´¥ï¼Œä»»åŠ¡çŠ¶æ€æ­£ç¡®

## ğŸ¯ **éªŒè¯è¦ç‚¹**

1. **æ‰£è´¹æˆåŠŸåœºæ™¯**ï¼š
   - æ—¥å¿—æ˜¾ç¤º"âœ… ç¿»è¯‘ä»»åŠ¡æ‰£è´¹æˆåŠŸ"
   - ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
   - ç”¨æˆ·ä½™é¢æ­£ç¡®æ‰£å‡

2. **æ‰£è´¹å¤±è´¥åœºæ™¯**ï¼š
   - æ—¥å¿—æ˜¾ç¤º"âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¤±è´¥"
   - ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
   - UIæ˜¾ç¤º"æ‰£è´¹å¤±è´¥"é”™è¯¯
   - ç”¨æˆ·ä½™é¢ä¸å˜

3. **ç½‘ç»œå¼‚å¸¸åœºæ™¯**ï¼š
   - æ—¥å¿—æ˜¾ç¤º"âŒ ç¿»è¯‘ä»»åŠ¡æ‰£è´¹å¼‚å¸¸"
   - ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
   - é”™è¯¯ä¿¡æ¯åŒ…å«å…·ä½“å¼‚å¸¸

## ğŸ”® **ä¸‹ä¸€æ­¥è®¡åˆ’**

1. **æµ‹è¯•éªŒè¯**ï¼šåœ¨ä¸åŒç½‘ç»œç¯å¢ƒä¸‹æµ‹è¯•ä¿®å¤æ•ˆæœ
2. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·å¯¹æ–°é”™è¯¯å¤„ç†çš„åé¦ˆ
3. **åŠŸèƒ½å¢å¼º**ï¼šæ ¹æ®éœ€è¦å®ç°é˜¶æ®µ2çš„é‡è¯•æœºåˆ¶
4. **ç›‘æ§ä¼˜åŒ–**ï¼šæ·»åŠ æ‰£è´¹æˆåŠŸç‡ç›‘æ§
